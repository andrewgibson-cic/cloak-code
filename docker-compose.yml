version: '3.8'

services:
  # CloakCode Proxy - The "Keyring" that holds real credentials
  # v2.0 - Strategy-based architecture with AWS SigV4 support
  proxy:
    build:
      context: ./proxy
      dockerfile: Dockerfile
    image: cloakcode-proxy:latest
    container_name: cloakcode_proxy
    hostname: proxy
    networks:
      - cloakcode_internal
    ports:
      - "8080:8080"
    volumes:
      - ./.env:/app/.env:ro
      - ./proxy/config.yaml:/app/config.yaml:ro
      - ./credentials.yml:/app/credentials.yml:ro
      - cloakcode_certs:/certs
      # Persistent logs directory
      - ./logs:/logs:rw
    env_file:
      - .env
    environment:
      - LOG_LEVEL=DEBUG
    command:
      - mitmdump
      - --mode
      - regular
      - --showhost
      - --set
      - confdir=/certs
      - --set
      - ssl_insecure=true
      - --set
      - block_global=false
      - --listen-host
      - 0.0.0.0
      - --listen-port
      - "8080"
      - -s
      - /app/inject.py
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mitmdump", "--version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Agent Container - The "Untrusted" Application/Workspace
  agent:
    build:
      context: ./agent
      dockerfile: Dockerfile
    image: cloakcode-agent:latest
    container_name: cloakcode_agent
    hostname: agent
    networks:
      - cloakcode_internal
    volumes:
      - cloakcode_agent_auth:/home/agent/.config
      - cloakcode_certs:/certs:ro
      - ./workspace:/home/agent/workspace
      # SSH keys for git operations (if ssh-keys directory exists)
      # Automatically mounted by make install/setup
      - ./ssh-keys:/ssh-keys:ro
      # Persistent logs directory
      - ./logs:/home/agent/logs:rw
      # Logging utilities
      - ./agent/logging_utils.sh:/usr/local/bin/logging_utils.sh:ro
    environment:
      # Explicit proxy mode
      HTTP_PROXY: "http://proxy:8080"
      HTTPS_PROXY: "http://proxy:8080"
      NO_PROXY: "localhost,127.0.0.1"
      
      # Node.js certificate trust
      NODE_EXTRA_CA_CERTS: "/usr/local/share/ca-certificates/mitmproxy-ca-cert.pem"
      
      # Python certificate trust
      REQUESTS_CA_BUNDLE: "/etc/ssl/certs/ca-certificates.crt"
      SSL_CERT_FILE: "/etc/ssl/certs/ca-certificates.crt"
      
      # DUMMY credentials (will be replaced by proxy)
      OPENAI_API_KEY: "DUMMY_OPENAI_KEY"
      GITHUB_TOKEN: "DUMMY_GITHUB_TOKEN"
      ANTHROPIC_API_KEY: "DUMMY_ANTHROPIC_KEY"
      AWS_ACCESS_KEY_ID: "AKIA00000000DUMMYKEY"
      AWS_SECRET_ACCESS_KEY: "DUMMY_AWS_SECRET_KEY"
      AWS_DEFAULT_REGION: "us-east-1"
    depends_on:
      proxy:
        condition: service_healthy
    stdin_open: true
    tty: true
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "--version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '2'
          memory: 2G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  cloakcode_internal:
    driver: bridge
    internal: false
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  cloakcode_agent_auth:
    driver: local
  cloakcode_certs:
    driver: local
