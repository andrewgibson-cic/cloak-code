version: '3.8'

services:
  # Universal Injector Proxy - The "Keyring" that holds real credentials
  # v2.0 - Strategy-based architecture with AWS SigV4 support
  proxy:
    build:
      context: ./proxy
      dockerfile: Dockerfile
    container_name: universal_injector_proxy
    hostname: proxy
    networks:
      - injector_internal
    ports:
      # Expose proxy port for debugging/explicit mode (optional, can be removed for pure transparent mode)
      - "8080:8080"
    volumes:
      # Mount the .env file containing REAL credentials (v1 backward compatibility)
      # CRITICAL: This file must NEVER be mounted to the agent container
      - ./.env:/app/.env:ro
      # Mount v2 configuration file (preferred)
      - ./proxy/config.yaml:/app/config.yaml:ro
      # Mount v1 credentials file (backward compatibility)
      - ./credentials.yml:/app/credentials.yml:ro
      # Shared certificate volume for MITM trust
      - certs:/certs
    env_file:
      # Load real credentials from .env file
      - .env
    # TRANSPARENT MODE REQUIREMENTS
    privileged: true  # Required for iptables manipulation
    cap_add:
      - NET_ADMIN  # Network administration capability
    command: >
      sh -c "
        echo 'Setting up transparent proxy with iptables...' &&
        iptables -t nat -A OUTPUT 
          -p tcp 
          -m owner ! --uid-owner mitmproxy 
          -m multiport --dports 80,443 
          -j REDIRECT --to-port 8080 &&
        echo 'iptables rules configured successfully' &&
        echo 'Starting Universal Injector v2.0...' &&
        mitmdump 
          --mode transparent 
          --showhost 
          --set confdir=/certs 
          --set ssl_insecure=true 
          --set block_global=false 
          --listen-host 0.0.0.0 
          --listen-port 8080 
          -s /app/inject.py
      "
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mitmdump", "--version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Agent Container - The "Untrusted" Application/Workspace
  # Can be any application that makes API calls
  agent:
    build:
      context: ./agent
      dockerfile: Dockerfile
    container_name: universal_injector_agent
    hostname: agent
    # TRANSPARENT MODE: Share network stack with proxy
    # This makes all agent traffic automatically flow through the proxy
    network_mode: "service:proxy"
    volumes:
      # Persistent authentication state (OAuth tokens) - Optional, depends on use case
      - agent_auth_data:/home/claude/.config/claude-code
      # Shared certificates for trusting the proxy
      - certs:/certs:ro
      # Bind mount the workspace (project code)
      # WARNING: Only mount the specific project directory, NOT your entire home folder
      - ./workspace:/home/claude/workspace
    environment:
      # TRANSPARENT MODE: No proxy environment variables needed!
      # Traffic is automatically intercepted via iptables
      # HTTP_PROXY and HTTPS_PROXY are NOT set
      
      # Node.js certificate trust
      NODE_EXTRA_CA_CERTS: "/usr/local/share/ca-certificates/mitmproxy-ca-cert.pem"
      
      # Python certificate trust
      REQUESTS_CA_BUNDLE: "/etc/ssl/certs/ca-certificates.crt"
      SSL_CERT_FILE: "/etc/ssl/certs/ca-certificates.crt"
      
      # DUMMY credentials (will be replaced by proxy transparently)
      # These can also be set in application code - proxy will intercept automatically
      OPENAI_API_KEY: "DUMMY_OPENAI_KEY"
      GITHUB_TOKEN: "DUMMY_GITHUB_TOKEN"
      ANTHROPIC_API_KEY: "DUMMY_ANTHROPIC_KEY"
      # AWS dummy credentials with proper format for SigV4 detection
      AWS_ACCESS_KEY_ID: "AKIA00000000DUMMYKEY"
      AWS_SECRET_ACCESS_KEY: "DUMMY_AWS_SECRET_KEY"
      AWS_DEFAULT_REGION: "us-east-1"
    depends_on:
      proxy:
        condition: service_healthy
    stdin_open: true  # Enable interactive mode
    tty: true         # Allocate a pseudo-TTY
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "--version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    security_opt:
      - no-new-privileges:true
    # Resource limits (optional but recommended)
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '2'
          memory: 2G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  injector_internal:
    driver: bridge
    internal: false  # Allow external access through proxy
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  # Persistent storage for agent authentication tokens
  agent_auth_data:
    driver: local
  
  # Shared volume for proxy-generated certificates
  certs:
    driver: local
